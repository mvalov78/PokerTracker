# ü§ñ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú –ë–û–¢–ê –ù–ê –ü–†–û–î–ê–ö–®–ï–ù–ï

> **–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º timeout –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞**

## üö® –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **Vercel Runtime Timeout (504)**
- Polling API –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 30 —Å–µ–∫—É–Ω–¥
- –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–ø—Ä–æ—Å—ã
- –ë–æ—Ç –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### 2. **Hardcoded localhost URL**
- `photoHandler.ts` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `http://localhost:3000`
- API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω –±–æ—Ç–∞
- –¢—É—Ä–Ω–∏—Ä—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å

### 3. **–ü–ª–æ—Ö–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- –ù–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timeout protection
- –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏

## ‚úÖ –ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### üîß 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω photoHandler.ts

**–ü—Ä–æ–±–ª–µ–º–∞:** Hardcoded `http://localhost:3000/api/tournaments`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API URL –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
const appUrl = process.env.NEXT_PUBLIC_APP_URL || process.env.VERCEL_URL || "http://localhost:3000";
const apiUrl = appUrl.startsWith('http') ? appUrl : `https://${appUrl}`;
const apiEndpoint = `${apiUrl}/api/tournaments`;

// –î–æ–±–∞–≤–ª–µ–Ω timeout protection
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 —Å–µ–∫—É–Ω–¥ timeout

const apiResponse = await fetch(apiEndpoint, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(tournamentData),
  signal: controller.signal,
});

clearTimeout(timeoutId);
```

### üöÄ 2. –°–æ–∑–¥–∞–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ API endpoints

#### **`/api/bot/polling-optimized`**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 25 —Å–µ–∫—É–Ω–¥
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
- Health check —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

#### **`/api/bot/webhook-optimized`**
- –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 10 —Å–µ–∫—É–Ω–¥
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 –¥–ª—è Telegram

### üõ°Ô∏è 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
- üîê –ü—Ä–æ–±–ª–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401)
- üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (500)
- ‚è∞ Timeout –æ—à–∏–±–∫–∏
- üåê –ü—Ä–æ–±–ª–µ–º—ã —Å–µ—Ç–∏
- üêõ –û–±—â–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

## üéØ –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–û–î–ê–ö–®–ï–ù–ê

### **1. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel**

```bash
# –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞!
NEXT_PUBLIC_APP_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app

# –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
NEXT_PUBLIC_SUPABASE_URL=https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=–≤–∞—à-–∫–ª—é—á
SUPABASE_SERVICE_ROLE_KEY=–≤–∞—à-—Å–µ—Ä–≤–∏—Å-–∫–ª—é—á
TELEGRAM_BOT_TOKEN=–≤–∞—à-—Ç–æ–∫–µ–Ω-–±–æ—Ç–∞

# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è webhook
BOT_MODE=webhook
BOT_WEBHOOK_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/bot/webhook-optimized
BOT_AUTO_RESTART=true
```

### **2. Redeploy –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
1. –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard
2. Deployments ‚Üí Redeploy –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–ø–ª–æ–π
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### **3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞ –Ω–∞ webhook (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

Webhook —Ä–µ–∂–∏–º –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π endpoint
BOT_WEBHOOK_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/bot/webhook-optimized
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### **1. Health Check**
```bash
curl https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/bot/polling-optimized
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
```json
{
  "success": true,
  "polling": {
    "isRunning": true,
    "mode": "webhook",
    "apiUrl": "https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app"
  }
}
```

### **2. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞**
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –±–∏–ª–µ—Ç–∞ –±–æ—Ç—É
2. –ù–∞–∂–º–∏—Ç–µ "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç—É—Ä–Ω–∏—Ä —Å–æ–∑–¥–∞–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤**
–í Vercel Dashboard ‚Üí Functions ‚Üí View Function Logs:
- –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å timeout –æ—à–∏–±–æ–∫
- API –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è < 25 —Å–µ–∫—É–Ω–¥

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### ‚úÖ **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚ùå Timeout 504 –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
- ‚ùå "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞"
- ‚ùå Hardcoded localhost URL
- ‚ùå –ü–ª–æ—Ö–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### ‚úÖ **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ (< 25 —Å–µ–∫)
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–æ–≤
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π API URL –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ Timeout protection
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞

## üîÑ –ü–ï–†–ï–•–û–î –ù–ê WEBHOOK (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

### **1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ Telegram**
```bash
curl -X POST "https://api.telegram.org/bot<–í–ê–®_–¢–û–ö–ï–ù>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/bot/webhook-optimized"}'
```

### **2. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**
```bash
BOT_MODE=webhook
BOT_WEBHOOK_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/bot/webhook-optimized
```

### **3. Redeploy**
–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ redeploy.

## üö® –≠–ö–°–¢–†–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è:

### **1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```bash
curl https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/health
```

### **2. –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ polling**
```bash
BOT_MODE=polling
# –£–±–µ—Ä–∏—Ç–µ BOT_WEBHOOK_URL
```

### **3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel**
- Functions ‚Üí View Function Logs
- –ò—â–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

**üéØ –≠—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –±–æ—Ç–æ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!**

**üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel –∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
