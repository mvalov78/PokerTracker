name: Auto-sync Bot Webhook After Deploy

# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—É—à–∞ –≤ main
on:
  push:
    branches:
      - main
  workflow_dispatch: # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  wait-for-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Vercel deployment
        run: |
          echo "‚è≥ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –Ω–∞ Vercel..."
          echo "Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ø–ª–æ–∏—Ç –ø—Ä–∏ –ø—É—à–µ –≤ main"
          sleep 90
          echo "‚úÖ –î–µ–ø–ª–æ–π –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è"
      
      - name: Initialize Bot with webhook from environment
        run: |
          echo "üîó –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º webhook –∏–∑ BOT_WEBHOOK_URL..."
          
          RESPONSE=$(curl -s -X POST https://poker-tracker-ashy.vercel.app/api/bot/init)
          
          echo "üìä –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          
          if [ "$SUCCESS" = "true" ]; then
            echo "‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            
            MODE=$(echo "$RESPONSE" | jq -r '.mode')
            WEBHOOK_URL=$(echo "$RESPONSE" | jq -r '.webhookUrl')
            
            echo "üìã –†–µ–∂–∏–º: $MODE"
            echo "üîó Webhook URL: $WEBHOOK_URL"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ webhook"
            ERROR=$(echo "$RESPONSE" | jq -r '.error')
            echo "–û—à–∏–±–∫–∞: $ERROR"
            exit 1
          fi
      
      - name: Verify webhook status
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å webhook..."
          
          RESPONSE=$(curl -s https://poker-tracker-ashy.vercel.app/api/bot/init)
          
          RECOMMENDATION=$(echo "$RESPONSE" | jq -r '.recommendation')
          TELEGRAM_URL=$(echo "$RESPONSE" | jq -r '.telegram.webhookInfo.url')
          ENV_URL=$(echo "$RESPONSE" | jq -r '.environment.BOT_WEBHOOK_URL')
          PENDING=$(echo "$RESPONSE" | jq -r '.telegram.webhookInfo.pending_update_count')
          
          echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏:"
          echo "  - Webhook –≤ Telegram: $TELEGRAM_URL"
          echo "  - Webhook –≤ .env: $ENV_URL"
          echo "  - –û–∂–∏–¥–∞—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: $PENDING"
          echo "  - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: $RECOMMENDATION"
          
          if [ "$RECOMMENDATION" = "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞" ]; then
            echo "‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!"
          else
            echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: $RECOMMENDATION"
          fi

