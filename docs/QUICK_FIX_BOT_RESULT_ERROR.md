# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—É—Ä–Ω–∏—Ä–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

**–î–∞—Ç–∞:** 1 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.4.8  
**–¢–∏–ø –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** Critical Bug Fix

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—É—Ä–Ω–∏—Ä–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (–∫–æ–º–∞–Ω–¥–∞ `/result`), –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ç—É—Ä–Ω–∏—Ä–∞ –∏ –≤–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "15 - 0", –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è.

### –ü—Ä–∏—á–∏–Ω–∞
API routes `/api/tournaments/[id]` –∏ `/api/tournaments` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `TournamentService`, –∫–æ—Ç–æ—Ä—ã–π –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `createClientComponentClient()`. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 

–ö–æ–≥–¥–∞ Telegram –±–æ—Ç –¥–µ–ª–∞–µ—Ç API –∑–∞–ø—Ä–æ—Å—ã, —É –Ω–µ–≥–æ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ—ç—Ç–æ–º—É –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Supabase –æ—Ç–∫–ª–æ–Ω—è–ª–∏—Å—å –∏–∑-–∑–∞ Row Level Security (RLS) –ø–æ–ª–∏—Ç–∏–∫.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ò–∑–º–µ–Ω–µ–Ω—ã API routes –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `createAdminClient()` –≤–º–µ—Å—Ç–æ `TournamentService`:

### 1. `/api/tournaments/[id]/route.ts`
- **GET –º–µ—Ç–æ–¥**: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `createAdminClient()` –≤–º–µ—Å—Ç–æ `TournamentService.getTournamentById()`
- **PUT –º–µ—Ç–æ–¥**: –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —á–µ—Ä–µ–∑ admin client
- **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –î–æ–±–∞–≤–ª–µ–Ω–æ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 2. `/api/tournaments/route.ts`
- **GET –º–µ—Ç–æ–¥**: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `createAdminClient()` –≤–º–µ—Å—Ç–æ `TournamentService.getTournamentsByUserId()`
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã POST –∏ DELETE –º–µ—Ç–æ–¥—ã**: –û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `TournamentService.createTournamentAsAdmin()`, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç admin client

## üîç –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```typescript
// API route –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª TournamentService
const tournament = await TournamentService.getTournamentById(tournamentId)

// TournamentService –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª client component client
const supabase = createClientComponentClient() // ‚ùå –¢—Ä–µ–±—É–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```typescript
// API route –∏—Å–ø–æ–ª—å–∑—É–µ—Ç admin client –Ω–∞–ø—Ä—è–º—É—é
const supabase = createAdminClient() // ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ—Å—Å–∏–∏

const { data: tournament, error } = await supabase
  .from('tournaments')
  .select('*')
  .eq('id', tournamentId)
  .single()
```

## üìä –í–ª–∏—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ API route: `/api/tournaments/[id]` (GET, PUT)
- ‚úÖ API route: `/api/tournaments` (GET)
- ‚úÖ Telegram bot –∫–æ–º–∞–Ω–¥—ã: `/result`, `/tournaments`

### –ß—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç client component client —Å —Å–µ—Å—Å–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ `createTournamentAsAdmin`)
- ‚úÖ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/result` –≤ Telegram –±–æ—Ç–µ
2. –í—ã–±—Ä–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
3. –í–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ "15 - 0" –∏–ª–∏ "1 | 2500"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/stats` –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
```bash
npm test src/__tests__/api/tournaments
```

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```typescript
console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', resultError)
console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞:', finalError)
```

### –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```typescript
return new NextResponse(
  JSON.stringify({ 
    success: false, 
    error: error instanceof Error ? error.message : 'Failed to update tournament' 
  }),
  { status: 500, headers: { 'content-type': 'application/json' } }
)
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Row Level Security (RLS)
- Admin client –æ–±—Ö–æ–¥–∏—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
- RLS –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∑–∞—â–∏—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ client component client
- –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `getUserOrCreate()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ user_id –∏–∑ Telegram ID

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
```typescript
// –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram ID
if (userId && /^\d+$/.test(userId)) {
  const user = await getUserOrCreate(parseInt(userId))
  actualUserId = user?.id || null
}

// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç—É—Ä–Ω–∏—Ä—ã —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
.eq('user_id', actualUserId)
```

## üì¶ –î–µ–ø–ª–æ–π

### Production
```bash
git add .
git commit -m "fix: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞"
git push origin main
```

### Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üîÑ Rollback plan
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è:
```bash
git revert HEAD
git push origin main
```

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- `src/app/api/tournaments/[id]/route.ts` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π API route
- `src/app/api/tournaments/route.ts` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π API route
- `src/bot/commands.ts` - –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –±–æ—Ç–µ
- `src/services/tournamentService.ts` - –°–µ—Ä–≤–∏—Å —Ç—É—Ä–Ω–∏—Ä–æ–≤ (–Ω–µ –∏–∑–º–µ–Ω—è–ª—Å—è)

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω API route `/api/tournaments/[id]`
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω API route `/api/tournaments`
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω –ª–∏–Ω—Ç–µ—Ä (0 –æ—à–∏–±–æ–∫)
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ CRITICAL  
**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~15 –º–∏–Ω—É—Ç

