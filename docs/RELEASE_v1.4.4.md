# Release v1.4.4 - Critical Bot Sessions Fix

**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** 2025-11-01  
**–¢–∏–ø:** üî¥ Critical Bug Fix  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready for Production

---

## üêõ Critical Bug Fix: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞" –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—É—Ä–Ω–∏—Ä–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/result`
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç—É—Ä–Ω–∏—Ä
4. **–û—à–∏–±–∫–∞**: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞" ‚ùå

### –ü—Ä–∏—á–∏–Ω–∞

Telegram –±–æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π** (`Map<number, SessionData>`), –∫–æ—Ç–æ—Ä–æ–µ **—Ç–µ—Ä—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏ Vercel**.

### –†–µ—à–µ–Ω–∏–µ

‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω **`BotSessionService`** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π –≤ **PostgreSQL (Supabase)**

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è

### `src/bot/index.ts`

#### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `BotSessionService`
```typescript
import { BotSessionService } from "@/services/botSessionService";
```

#### 2. –ó–∞–º–µ–Ω–µ–Ω middleware –¥–ª—è —Å–µ—Å—Å–∏–π
- **–ë—ã–ª–æ:** In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (`Map`)
- **–°—Ç–∞–ª–æ:** –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —á–µ—Ä–µ–∑ `BotSessionService`

```typescript
// Middleware –¥–ª—è —Å–µ—Å—Å–∏–π (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î)
this.bot.use(async (ctx, next) => {
  const userId = ctx.from?.id;
  if (!userId) {return next();}

  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Å—Å–∏—é –∏–∑ –ë–î
    const sessionData = await BotSessionService.getSession(userId);
    ctx.session = sessionData;
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    await next();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –æ–±—Ä–∞—Ç–Ω–æ –≤ –ë–î
    await BotSessionService.updateSession(userId, ctx.session);
  } catch (error) {
    console.error('Session middleware error:', error);
    // Fallback –Ω–∞ –ø—É—Å—Ç—É—é —Å–µ—Å—Å–∏—é
    ctx.session = { /* ... */ };
    await next();
  }
});
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω `createMockContext` –¥–ª—è –º–æ–∫-—Ä–µ–∂–∏–º–∞
- –ú–µ—Ç–æ–¥ —Å—Ç–∞–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑ –ë–î

#### 4. –û–±–Ω–æ–≤–ª–µ–Ω `processUpdate` –¥–ª—è –º–æ–∫-—Ä–µ–∂–∏–º–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### üîí –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–π
- –°–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤ webhook, —Ç–∞–∫ –∏ –≤ polling —Ä–µ–∂–∏–º–µ

### üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
- –°–µ—Å—Å–∏–∏ –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ (`expires_at`)
- –§—É–Ω–∫—Ü–∏—è `cleanup_expired_bot_sessions()` –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- Row Level Security (RLS) –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- –¢–æ–ª—å–∫–æ service_role –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Å—Å–∏—è–º–∏

### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `user_id` –∏ `expires_at` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- JSONB —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit Tests
‚úÖ **40 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ**
- `src/__tests__/services/botSessionService.test.ts` - 20 passed
- `src/__tests__/services/botSettingsService.test.ts` - 20 passed

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/result` ‚úÖ
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚úÖ
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç—É—Ä–Ω–∏—Ä ‚Üí callback_query ‚úÖ
4. **–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î** ‚úÖ
5. –ë–æ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `currentAction = 'add_result'` ‚úÖ
6. **–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î** ‚úÖ
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å) ‚úÖ
8. **–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î** ‚úÖ
9. –ë–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ

---

## üì¶ –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- ‚úèÔ∏è `src/bot/index.ts` - –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ (middleware –¥–ª—è —Å–µ—Å—Å–∏–π)
- üìÑ `docs/QUICK_FIX_BOT_SESSIONS.md` - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- üìÑ `docs/RELEASE_v1.4.4.md` - –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

---

## üöÄ Deployment

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git status

# 2. –î–æ–±–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add src/bot/index.ts docs/QUICK_FIX_BOT_SESSIONS.md docs/RELEASE_v1.4.4.md

# 3. –ö–æ–º–º–∏—Ç
git commit -m "fix(bot): Replace in-memory sessions with database-persisted sessions for serverless compatibility

- Fixed 'Unknown command' error when selecting tournament in production
- Integrated BotSessionService for persistent session storage
- Updated middleware to load/save sessions from PostgreSQL
- Ensures sessions survive serverless function invocations
- All tests passing (40/40)

Closes #bot-sessions-issue"

# 4. –ü—É—à –≤ main
git push origin main

# 5. Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

1. –ó–∞–π—Ç–∏ –≤ Telegram –±–æ—Ç
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/result`
3. –í—ã–±—Ä–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ë–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–ú–µ—Å—Ç–æ | –í—ã–∏–≥—Ä—ã—à`
5. –í–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä: `1 | 2500`
6. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå –û—à–∏–±–∫–∞ "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞" –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- ‚ùå –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (40/40)

---

## üîÆ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —á–µ—Ä–µ–∑ cron job
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–π
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–µ—Å—Å–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [QUICK_FIX_BOT_SESSIONS.md](./QUICK_FIX_BOT_SESSIONS.md) - –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- [TELEGRAM_BOT_SESSION_FIX.md](./TELEGRAM_BOT_SESSION_FIX.md) - –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
- [RELEASE_v1.4.3.md](./RELEASE_v1.4.3.md) - –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–ª–∏–∑

---

## üë• Contributors

- **AI Assistant** - Implementation
- **User (mvalov)** - Bug report & testing

---

**–í–µ—Ä—Å–∏—è:** 1.4.4  
**–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è:** 1.4.3  
**–°–ª–µ–¥—É—é—â–∞—è –≤–µ—Ä—Å–∏—è:** 1.4.5 (planned)

