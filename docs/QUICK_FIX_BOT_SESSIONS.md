# üîß Quick Fix: Bot Sessions Issue in Production

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—É—Ä–Ω–∏—Ä–∞ –≤ Telegram –±–æ—Ç–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–Ω–∞ —ç—Ç–∞–ø–µ –≤—ã–±–æ—Ä–∞ —Ç—É—Ä–Ω–∏—Ä–∞) –≤—ã–¥–∞–≤–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞ **"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞"**.

## –ü—Ä–∏—á–∏–Ω–∞

Telegram –±–æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π** (`Map<number, SessionData>`), –∫–æ—Ç–æ—Ä–æ–µ —Ç–µ—Ä—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ **serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏ Vercel**.

### –ü–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/result`
2. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤ —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É ‚Üí callback_query –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
4. **–ù–æ–≤—ã–π serverless –∏–Ω—Å—Ç–∞–Ω—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** (—Å—Ç–∞—Ä–∞—è in-memory —Å–µ—Å—Å–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞)
5. –ë–æ—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é ‚Üí –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞"

## –†–µ—à–µ–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ **`BotSessionService`** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π –≤ **PostgreSQL (Supabase)** –≤–º–µ—Å—Ç–æ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/bot/index.ts`:

#### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `BotSessionService`

```typescript
import { BotSessionService } from "@/services/botSessionService";
```

#### 2. –£–¥–∞–ª–µ–Ω–æ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

```typescript
// –ë—ã–ª–æ:
private sessions: Map<number, SessionData> = new Map();

// –°—Ç–∞–ª–æ:
// –°–µ—Å—Å–∏–∏ —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î —á–µ—Ä–µ–∑ BotSessionService
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω middleware –¥–ª—è —Å–µ—Å—Å–∏–π

```typescript
// –ë—ã–ª–æ: –ø—Ä–æ—Å—Ç–æ–µ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
this.bot.use((ctx, next) => {
  const userId = ctx.from?.id;
  if (!userId) {return next();}

  if (!this.sessions.has(userId)) {
    this.sessions.set(userId, { /* ... */ });
  }

  ctx.session = this.sessions.get(userId)!;
  return next();
});

// –°—Ç–∞–ª–æ: –∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
this.bot.use(async (ctx, next) => {
  const userId = ctx.from?.id;
  if (!userId) {return next();}

  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Å—Å–∏—é –∏–∑ –ë–î
    const sessionData = await BotSessionService.getSession(userId);
    ctx.session = sessionData;
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    await next();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –æ–±—Ä–∞—Ç–Ω–æ –≤ –ë–î
    await BotSessionService.updateSession(userId, ctx.session);
  } catch (error) {
    console.error('Session middleware error:', error);
    // Fallback –Ω–∞ –ø—É—Å—Ç—É—é —Å–µ—Å—Å–∏—é
    ctx.session = { /* ... */ };
    await next();
  }
});
```

#### 4. –û–±–Ω–æ–≤–ª–µ–Ω `createMockContext` –¥–ª—è –º–æ–∫-—Ä–µ–∂–∏–º–∞

```typescript
// –ú–µ—Ç–æ–¥ —Å—Ç–∞–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑ –ë–î
private async createMockContext(update: any): Promise<BotContext> {
  const userId = update.message?.from?.id || update.callback_query?.from?.id;
  let session: SessionData = { userId: userId?.toString() };
  
  // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ –ë–î
  if (userId) {
    try {
      session = await BotSessionService.getSession(userId);
    } catch (error) {
      console.error('Error loading session for mock context:', error);
    }
  }
  
  return { /* ... */ session };
}
```

#### 5. –û–±–Ω–æ–≤–ª–µ–Ω `processUpdate` –¥–ª—è –º–æ–∫-—Ä–µ–∂–∏–º–∞

```typescript
// –î–æ–±–∞–≤–ª–µ–Ω await –¥–ª—è createMockContext
const ctx = await this.createMockContext(update);

// ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥, —Ñ–æ—Ç–æ, —Ç–µ–∫—Å—Ç–∞, callback

// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è –º–æ–∫ —Ä–µ–∂–∏–º–∞)
const userId = ctx.from?.id;
if (userId) {
  await BotSessionService.updateSession(userId, ctx.session);
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–π
- –°–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ serverless –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤ webhook, —Ç–∞–∫ –∏ –≤ polling —Ä–µ–∂–∏–º–µ

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
- –°–µ—Å—Å–∏–∏ –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ (`expires_at`)
- –§—É–Ω–∫—Ü–∏—è `cleanup_expired_bot_sessions()` –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- Row Level Security (RLS) –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- –¢–æ–ª—å–∫–æ service_role –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Å—Å–∏—è–º–∏

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `user_id` –∏ `expires_at` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- JSONB —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `bot_sessions`

```sql
CREATE TABLE bot_sessions (
  id UUID PRIMARY KEY,
  user_id BIGINT NOT NULL UNIQUE,        -- Telegram user ID
  session_data JSONB NOT NULL DEFAULT '{}', -- –î–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours')
);
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∞:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/result`
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç—É—Ä–Ω–∏—Ä ‚Üí callback_query
4. **–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î** ‚úÖ
5. –ë–æ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `currentAction = 'add_result'`
6. **–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î** ‚úÖ
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)
8. **–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î** ‚úÖ
9. –ë–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
npm test

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞
npm run lint

# –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
cd /Users/mvalov/PokerTracker && npm run dev
```

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —á–µ—Ä–µ–∑ cron job
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–π
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–µ—Å—Å–∏–π

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/bot/index.ts` - –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ —Å middleware
- `src/services/botSessionService.ts` - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏
- `sql-scripts/add-bot-sessions-table.sql` - SQL —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**2025-11-01** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞" –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–í–µ—Ä—Å–∏—è**: 1.4.4 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

